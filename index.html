<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width; initial-scale=1.0;">
<script type="coffee">

# TODO
# - telegram icon/link?
# - "invite friends" with way to copy URL to clipboard
# - bigger question lists
# - ...animations?
# - make more fun IDs (noun concat)
# - beautiful typography
# - dark/light themes

# BUGS
# - Zooming (including pinch-zooming) screws up font size


#--- COMMON ---#

NAMESPACE_PREFIX = 'askholeweb_'

questions = [
    "In what ways are you inhibited from expressing love?",
    "What difficult or painful experience would you recommend to everyone?",
    "What's the most intense emotional pain you've ever experienced?",
    "In what ways don't you trust yourself?",
    "How have you disappointed your parents?",
    "What about yourself have you been trying to fix for a long time?",
    "How would you raise a child differently from how your parents raised you?",
    "What was the last thing you cried about? When was it?",
    "What was the most difficult thing you've ever had to do?",
    "In what ways do you tend to fail at communication?",
    "What is currently your greatest insecurity?",
    "Which of your habits conflicts with your values?",
    "What aspect about the person to your left gives you the strongest negative feeling?",
    "What do you still owe someone an apology for?",
    "What's the most sick (mental or physical) you've ever been?",
    "Who do you hate most?",
    "What is your biggest obstacle toward peace?",
    "What about your appearance would you like to change?",
    "What have you done that you are most ashamed of?",
    "Are you afraid of death? Why or why not?",
    "How do you heal from painful experiences? How do you know when you're done healing?",
    "What was your biggest financial mistake?",
    "What's the most intense physical pain you've ever experienced?",
    "How often and in what ways does fear show up in you?",
    "Which have you planned in greater detail: killing yourself, or killing someone else?",
    "Who in this room would you most like to have sex with?",
    "If everyone in the room were arranged on a spectrum of attractiveness, which two people would you be between?",
    "What problems do you see in the relationships of those around you?",
    "You have to marry someone in this room right now. Who is it?",
    "Is there anything which arouses you that you've never admitted to anybody?",
    "What unusual trait do you find most attractive in a romantic partner?",
    "Out of all your past sexual experiences, what has made you the most uncomfortable?",
    "If you were invited to an all-nude party, where all the participants are required to be naked the whole time, would you go?",
    "When you introspect, away from society and your physical body, deep inside, do you feel a sense of gender?",
    "What were the conditions of your last break-up?",
    "If you had to choose one, would you rather double or halve your sex drive?",
    "Would you rather fuck your girlfriend who is inhabiting your mother's body, or your mother who is inhabiting your girlfriend's body? (If you date men, switch it to boyfriend and father.)",
    "In total, have you given or received more oral sex?",
    "What's one of the most adventurous things you've ever done in bed?",
    "Would you date yourself?",
    "What percentage of your preferred age/gender demographic would you be down to have sex with after roughly an hour of flirting?",
    "Have you ever been in an open or polyamorous relationship? If not, would you consider it?",
    "Could you have a serious relationship with someone who expressed that they thought they were unworthy of the relationship?",
    "Have you ever dated someone who you felt was below your standards?",
    "How easy is it for you to orgasm?",
    "Do you ever feel guilt or shame for romantically rejecting people who are interested in you?",
    "If you could press a button and double the sex drive of all women on earth, would you do it?",
    "If you tried, could you list the names of everyone you've had sex with?",
    "Are yelling fights in relationships more typical and inevitable, or terrible and avoidable?",
    "What was your most disappointing sexual experience?",
    "What emotion/feeling are you currently suppressing or ignoring?",
    "Who in the room do you admire the most?",
    "Did your parents do a good job?",
    "What are the signs that someone understands you uniquely?",
    "What is the best advice you've received, and why did you need it?",
    "What are you waiting to hear from someone close to you?",
    "What do you most admire about the person to your right?",
    "At the gut level, do you feel that the world is safe or not safe?",
    "Would you rather increase the amount that people respect you, or increase the amount they desire you?",
    "What relatively common experience have you never had?",
    "Do you ever enjoy the experience of emotional pain?",
    "Have you been loved enough?",
    "Have you ever had (what you consider to be) a spiritual experience? If so, what was it like and what effects did it have on you?",
    "Do you feel a greater sense of satisfaction when you gain approval from people who are very similar to you, or very different from you?",
    "If you could have one but not the other, would you rather love someone or be loved by someone?",
    "What kind of people do you get along best with?",
    "Which of your achievements are you most proud of?",
    "Given the guarantee that nobody will ask you the question: What is a question that you would refuse to answer?",
    "How boring are you?",
    "Do you have more thoughts or more feelings?",
    "What are your coping mechanisms for stress?",
    "Would you rather double the amount of emotional pain and pleasure you feel on a daily basis, or cut both in half?",
    "What is the most interesting fact about you that few people know?",
    "Which of your personality traits are you most proud of?",
    "Which group is larger: people who trust you, or people you trust?",
    "What is the most significant thing you've ever changed your mind about?",
    "If you could ask everybody in the world one question, what would it be? You don't get to hear their answers.",
    "Are some human lives worth more than others?",
    "You must pick a number right now and live that many years total, in good physical health. You can't die before, and you can't extend after. How many years do you choose to live?",
    "Do you consider the state of \"unconditionally loving everyone\" to be desirable or undesirable for you, given it were possible?",
    "Are there any thoughts so offensive that you would advocate shaming those who think them, even if they don't act on those thoughts?",
    "Which of your beliefs would be the most difficult to change, even in the face of overwhelming evidence?",
    "Are there any cases in which you would support forced, involuntary brain modification to change someone else's mind, urges, or behavior?",
    "You can make a designer baby. Would you rather optimize it primarily for intelligence or happiness/optimism?",
    "What do you think enlightenment is?",
    "Do you believe the set of concepts like \"duty\", \"should\", \"obligation\", and \"deserving\" are ultimately more valid or meaningless?",
    "If you could press a button that would make you feel deeply and permanently that everything was ok, would you? Assume that you'd remain functional in the world.",
    "Can someone both be a kind person and also hold the exact opposite of your political views?",
    "If you could, would you wirehead (i.e. hook yourself up to a hypothetical machine that makes you totally and eternally happy and satisfied)?",
    "If you (and only you) could see one measurement or statistic over everyone's heads, what would you want it to indicate?",
    "Would you prefer to date someone 20 IQ points higher or 5 points lower than you?",
    "If you could press a button that would instantly erase every single false belief you have, would you do it?",
    "If you could ask the universe one question and get the truth, what would you want to know?",
    "Is torture ever permissible?",
    "On planet A, everyone's 30% dumber, and you're a genius by comparison. On planet B, everyone's 30% smarter, and you're an idiot by comparison. You stay the same. Which planet would you prefer to live on?",
    "Which technology should not have been invented?",
    "If you could magically cause a neutral nude photo of every human to be published publicly on the internet every year on their birthday, would you?",
    "Of all the beliefs you hold, which is most likely to be considered barbaric in 150 years?",
    "You see a friend getting into their third emotionally abusive relationship in a row. Are they a victim?",
    "Do you feel that you have conscious control over your beliefs? Could you, right now, decide to believe something else if you tried? If so, which beliefs?",
    "What's the most controversial opinion you hold among your own social group?",
    "What viewpoint is the most difficult for you to empathize with?",
    "Does \"no\" always really mean \"no\"?",
    "If you had to fuck a cow, would you rather it be dead or alive?",
    "Do you have any political or social opinions that you're afraid to express to your friends?",
    "In your personal experience, even if the difference is extremely slight, are men or women better at handling suffering?",
    "In a world where different ethnicities had strong genetic differences which caused different moral behavior, would racism be okay or still not okay?",
    "What groups or communities are you most judged for being a member of?",
    "In a world where prostitution becomes totally legal and regulated, should sex workers be allowed to refuse clients on the basis of race?",
    "Would you rather have accidentally killed someone, or be a nonoffending pedophile?",
    "Would you support the use of realistic child sex dolls by pedophiles?",
    "Would you rather be raped or falsely (but convincingly) accused of rape?",
    "Does modern western culture encourage women either to overreact or underreact to \"minor\" sexual assaults, such as groping, too-drunk sex, etc.?",
    "How do society's morals differ from your own?",
    "Regardless of your conscious beliefs or actions, do you feel in your gut that sex work is degrading?",
    "Which stereotype is actually pretty accurate?",
    "If you had to eliminate one million people from one ethnicity, which would it be?",
    "A 14-year-old has sex. How large does the age gap have to be between the 14-year-old and their partner before the child can no longer meaningfully consent to sex?",
    "If a sex worker consents to sex with a customer under expectation of payment, but then the customer refuses to pay, is this closer to rape or to theft?",
    "What's your opinion of education that teaches men to be more seductive?",
    "Do women have any systemic privilege due to their gender?",
    "Is incest wrong? Should it be illegal?",
    "Are there any viewpoints so offensive that they deserve to be shut down or suppressed? If so, which ones?",
    "Regardless of your support or personal feelings, does your subconscious view trans-identifying people as closer to their birth or current gender?",
    "Is bestiality wrong? Are you a vegan?"
    ]

questions_extended = [
    # "What is 'the moon'?",
    # "What's your favorite animal?",
    # "What don't you know about yourself?",
    # "Who is your arch-nemesis?",
    # "When was the last time you did something for the first time?",
    "To what do you attribute to your success?",
    "Have you named your genitals?",
    "Who is your alter ego?",
    "How do you predict you will die?",
    "What are you the patron saint of?",
    "How old do you feel?",
    "What's your greatest failure?",
    "What is the worst thing anyone has ever done to you?",
    "What are your most prized possessions?",
    "What's your boring superpower?"
    ]

# Generate a random integer up to (not including) max
getRandomInt = (max) ->
    Math.floor(Math.random() * Math.floor(max))

# Get a random integer guaranteed to be different from a current one
getDifferentRandomInt = (max, cur) ->
    n = getRandomInt(max)
    while n == cur
        n = getRandomInt(max)
    n

# from https://stackoverflow.com/questions/1349404/generate-random-string-characters-in-javascript
# dec2hex :: Integer -> String
# i.e. 0-255 -> '00'-'ff'
dec2hex = (dec) ->
    ('0' + dec.toString(16)).substr(-2)

# from https://stackoverflow.com/questions/1349404/generate-random-string-characters-in-javascript
# generateId :: Integer -> String
generateId = (len) ->
    arr = new Uint8Array((len || 40) / 2)
    window.crypto.getRandomValues(arr)
    Array.from(arr, dec2hex).join('')


#--- STATE ---#

getParty = ->
    hash = fetch('hash')
    if hash.val.length
        return fetch('/' + NAMESPACE_PREFIX + hash)
    else
        return {}

# Initialize viewport sizes.
getScreenSize = ->
    test = document.getElementsByTagName('body')[0]
    if test?
        return [test.clientWidth, test.clientHeight]
    else
        return [0.75*window.screen.width, 0.75*window.screen.height]

# Set the party hash.
setHash = (str) ->
    hash = fetch('hash')
    hash.val = str
    save(hash)

    party = getParty()

# Fisher-Yates algorithm
shuffle = (arr) ->
    a = bus.clone(arr)
    for i in [a.length-1..1] by -1
        j = Math.floor(Math.random() * (i + 1))
        [a[i], a[j]] = [a[j], a[i]]
    return a

shuffleDeck = ->
    party = getParty()
    party.order = shuffle([0..questions.length-1])
    save(party)

nextQuestion = ->
    party = getParty()
    len = questions.length
    party.index = (party.index + 1 + len) % len
    save(party)
    return true

prevQuestion = ->
    party = getParty()
    len = questions.length
    party.index = (party.index - 1 + len) % len
    save(party)
    return true

PARTY_PAGE = ->
    DIV { className: 'bgwhirl' },
        PAGE_HEADER()
        QUESTION()

LANDING_PAGE = ->
    hash = fetch('hash')

    DIV { className: 'bglogo' },
        PAGE_HEADER()
        DIV { className: 'home_button_wrap' },
            BUTTON
                className: 'home_button boxshadow',
                onClick: =>
                    id = generateId(10)
                    window.location.href = document.baseURI.split('#')[0] + '#' + id
                    setHash(id)
                "Create a room \u2192"
                # "Create a room →"

HELP_ICON = ->
    SPAN {
            className: "help_icon dropshadow",
            "data-micromodal-trigger": "modal-1",
            onClick: => MicroModal.show("modal-1")
        }

HELP_MODAL = ->
    DIV {
            className: "modal micromodal-slide",
            id: "modal-1",
            "aria-hidden": "true"
        },
        DIV {
                className: "modal__overlay",
                tabIndex: "-1",
                # "data-micromodal-close": ""
                onClick: (e) => if e.target.classList.contains("modal__overlay") then MicroModal.close("modal-1")
            },
            DIV {
                    className: "modal__container",
                    role: "dialog",
                    "aria-modal": "true",
                    "aria-labelledby": "modal-1-title"
                },
                HEADER { className: "modal__header" },
                    H2 {
                        className: "modal__title",
                        id: 'modal-1-title'
                        },
                        "What the f is this?"
                    BUTTON {
                        className: "modal__close",
                        "aria-label": 'Close modal',
                        # "data-micromodal-close": ""
                        onClick: => MicroModal.close("modal-1")
                    }
                MAIN {
                        className: "modal__content",
                        id: "modal-1-content"
                    },
                    # P {},
                    #     """
                    #     The abyss of loneliness, all too familiar to one like you.
                    #     """
                    P {},
                        """
                        Askhole Web is a web version of the 
                        """
                        A { href: '//askhole.io', target: "_blank" }, "terrible game you know and love"
                        """.
                        Traditionally, a physical deck of Askhole is used to ruin
                        house parties and family reunions, but now Askhole Web can be used
                        to ruin videochats and conference calls.
                        """
                    H2 {
                        className: "modal__title",
                        id: 'modal-1-title'
                        },
                        "Gimme the rundown"
                    P {},
                        """
                        When you visit 
                        """
                        A { href: "//web.askhole.io", target: "_blank" }, "web.askhole.io"
                        " "
                        """
                        and click the "Create a room" button, you'll be taken
                        to a new Askhole Web "chat room". Now this so-called
                        "chat room" doesn't have any chat functionality, and nor
                        is it a room, but what it does do is automatically
                        synchronize the question that is displayed with anyone
                        else who is also visiting the same URL.
                        """
                    P {},
                        """
                        So, if you're on a conference call or a group
                        videochat, you can share an Askhole Web link with all
                        your unlucky pals and remotely enjoy a good
                        old-fashioned round of Askhole.
                        """
                    P {},
                        """
                        A well-formed Askhole Web URL is anything of the form 
                        """
                        CODE "web.askhole.io/#SomeTextString"
                        "—you can put whatever you want after the"
                        CODE "#"
                        " to create a new room."
                    H2 {
                        className: "modal__title",
                        id: 'modal-1-title'
                        },
                        "How do I work this thing?"
                    P {},
                        "Click on the card to proceed to the next one. When the
                        question changes, it changes for "
                        EM "everyone"
                        " who is in the room (everyone who is visiting your
                        URL). That's about all there is to it."
                    # P  "(More functionality will likely be added in the
                    #     future, but for now that's all we got.)"
                    P "Keyboard shortcuts:"
                    P {},
                        CODE "\u2192"
                        " Next card"
                        BR()
                        CODE "\u2190"
                        " Previous card"
                        BR()
                        CODE "?"
                        " Open this help window"
                    H2 {
                        className: "modal__title",
                        id: 'modal-1-title'
                        },
                        "Something isn't exactly the way I want it"
                    P "Boo fuckin hoo."
                    P {},
                        "You can "
                        A { href: "mailto:askholecontact@gmail.com", target: "_blank" }, "send us an email"
                        ", "
                        A { href: "//t.me/askholecards", target: "_blank" }, "drop us a line on Telegram"
                        ", or "
                        A { href: "//github.com/rothos/askhole-web", target: "_blank" }, "check out the Github repo"
                        " to contact us with any suggestions, feature requests, bug reports,
                        surreal experiences, come-ons, etc."
                    H2 {
                        className: "modal__title",
                        id: 'modal-1-title'
                        },
                        "Talk sexy to me"
                    P {},
                        """
                        Askhole Web is built using 
                        """
                        A { href: '//stateb.us', target: "_blank" }, "Statebus"
                        " (AKA "
                        A { href: '//braid.news', target: "_blank" }, "Braid"
                        """), a state-of-the-art synchronization
                        technology. The app itself is written in delicious 
                        """
                        A { href: '//coffeescript.org', target: "_blank" }, "CoffeeScript"
                        ". "
                        """
                        It also makes use of the fantastic 
                        """
                        A { href: '//micromodal.now.sh', target: "_blank" }, "Micromodal.js"
                        " and "
                        A { href: '//getskeleton.com/', target: "_blank" }, "Skeleton.css"
                        "."

dom.BODY = ->
    str = window.location.hash.substring(1)
    setHash(str)

    hash = fetch('hash')
    DIV {className: 'wrap'},
        if hash.val
            PARTY_PAGE()
        else
            LANDING_PAGE()
        HELP_ICON()
        HELP_MODAL()

dom.PAGE_HEADER = ->
    DIV {className: 'header'},
        DIV { className: 'header_wordmark' },
            A {
                    className: 'wordmark'
                    href: '#'
                }, 'ASKHOLE WEB'
            SPAN { className: 'header_by' },
                'by '
                A {
                    href: '//askhole.io',
                    target: '_blank'
                    },
                    'askhole.io'
        # DIV { className: 'header_links' },
        #     A {
        #         className: 'tg',
        #         href: "https://t.me/askholecards"
        #     }

dom.QUESTION = ->
    party = getParty()

    party.index ?= 0
    party.order ?= shuffle([questions.length-1..0])
    save(party)

    n = party.index
    order = party.order

    question = if n? then questions[order[n]] else ''
    number = if n? then '#'+(order[n]+1).toString() else ''
    questiontext = if loading() then '[loading...]' else question

    DIV { className: 'main_wrap' },
        DIV {
                className: 'backbutton',
                onClick: prevQuestion
            },
            SPAN { className: 'dropshadow' }
        DIV { className: 'cardstuff_wrap' },
            DIV {
                    className: 'party_card boxshadow',
                    onClick: nextQuestion
                },
                DIV {
                        className: 'party_cardtext noselect',
                        id: 'card',
                        style: { fontSize: getCardFontSize(question.length) }
                    },
                    SPAN { className: 'party_questiontext' },
                        questiontext
                        SPAN { className: 'phantom' }, ' '+number+' '
                    SPAN { className: 'party_cardnumber' }, number
            DIV { className: 'card_footer' },
                A {
                        className: 'twitterlink boxshadow',
                        href: "https://twitter.com/intent/tweet?text=" + encodeURIComponent('"' + question + '" #AskholeQuestions')
                        target: "_blank"
                    },
                    SPAN { className: 'twittericon' }
                    SPAN { className: 'linktext' }, "Tweet this question"

# Calculate the card font size.
getCardFontSize = (length) ->
    client = fetch('client')
    qlength_const = Math.max(0.9, (Math.sqrt(length)+3)/12.5) || 1
    device_const = if Math.min(client.width, client.height) < 500 then 1.25 else 1
    resolution_const = Math.sqrt((client.width) * (client.height))
    fontsize = (device_const * resolution_const / qlength_const / 20).toFixed(1)
    if fontsize > 75 then fontsize = 75
    return fontsize + 'px'

# The screen resize handler.
onViewportSizeChange = (e) ->
    client = fetch('client')
    [client.width, client.height] = getScreenSize()
    save(client)
    return true

# Add an event listener for screen resize.
if window.visualViewport?
    window.visualViewport.addEventListener('resize', onViewportSizeChange)
else
    window.addEventListener('resize', onViewportSizeChange)

# Make sure everyting's in preper shape once the DOM has loaded.
window.addEventListener('DOMContentLoaded', onViewportSizeChange)

# Keyboard shortcuts for turning over a new question.
window.addEventListener('keydown', ( (e) ->
        if e.which in [13,32,39] then nextQuestion()
        if e.which in [37,8] then prevQuestion()
        if e.key in ["?"] then MicroModal.show("modal-1")
    )
)

# Reload the page whenever the URL hash changes.
window.addEventListener('hashchange', ( (e) -> dom.BODY() ))

</script>
<script src="https://stateb.us/client6.js" server='state://invisible.college'></script>
<script src="https://unpkg.com/micromodal/dist/micromodal.min.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-138298500-2"></script>
<script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);}
gtag('js', new Date()); gtag('config', 'UA-138298500-2');</script>
<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css'>
<link rel='stylesheet' href='common.css'>
<link rel='stylesheet' href='micromodal.css'>
<link href="https://fonts.googleapis.com/css2?family=Lato:ital@0;1&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
<script type='text/javascript'>MicroModal.init({awaitCloseAnimation: !0});</script>
<link href="favicon.png" rel="shortcut icon" type="image/x-icon"/>
<title>Askhole Web</title>
